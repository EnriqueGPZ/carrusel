<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>CaruselForge | Editor & AI</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.2/cropper.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.2/cropper.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

  <style>
    :root {
      /* Paleta Modern Dark (Slate/Zinc) */
      --bg: #020617;
      --surface-1: #0f172a;
      --surface-2: #1e293b;
      --surface-3: #334155;
      
      --border: #1e293b;
      --border-hover: #475569;
      
      --text-main: #f8fafc;
      --text-muted: #94a3b8;
      --text-dim: #64748b;

      /* Acentos */
      --primary: #6366f1; /* Indigo */
      --primary-hover: #4f46e5;
      --primary-fg: #ffffff;
      
      --danger: #ef4444;
      --danger-bg: rgba(239, 68, 68, 0.1);
      
      --success: #10b981;
      --warn: #f59e0b;
      
      /* Variables UI */
      --radius-sm: 6px;
      --radius-md: 8px;
      --radius-lg: 12px;
      --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3), 0 2px 4px -1px rgba(0, 0, 0, 0.15);
      --font-sans: 'Inter', system-ui, -apple-system, sans-serif;
    }

    * { box-sizing: border-box; outline: none; }
    
    html, body { height: 100%; overflow: hidden; }
    
    body {
      margin: 0;
      font-family: var(--font-sans);
      background-color: var(--bg);
      color: var(--text-main);
      background-image: radial-gradient(circle at 50% 0%, #1e1b4b 0%, transparent 45%);
      background-attachment: fixed;
      font-size: 14px;
      line-height: 1.5;
      display: flex; flex-direction: column;
    }

    /* --- Header --- */
    header {
      flex: 0 0 60px; 
      padding: 0 20px;
      background: rgba(2, 6, 23, 0.95);
      backdrop-filter: blur(12px);
      border-bottom: 1px solid var(--border);
      display: flex; align-items: center; justify-content: space-between;
      gap: 20px;
      z-index: 40;
    }

    .brand { display: flex; align-items: center; gap: 12px; flex: 0 0 auto; }
    .logo {
      width: 28px; height: 28px; border-radius: 8px;
      background: linear-gradient(135deg, #6366f1, #a855f7);
      display: flex; align-items: center; justify-content: center;
      color: white;
      box-shadow: 0 0 15px rgba(99, 102, 241, 0.3);
    }
    .title { margin: 0; font-weight: 600; font-size: 15px; color: var(--text-main); }

    /* --- Notification Area --- */
    #headerMsg {
      flex: 1; 
      text-align: center; 
      font-size: 13px; font-weight: 500;
      opacity: 0; transition: opacity 0.3s ease;
      pointer-events: none;
      white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    }
    #headerMsg.ok { color: var(--success); }
    #headerMsg.bad { color: var(--danger); }
    #headerMsg.warn { color: var(--warn); }
    #headerMsg.info { color: var(--text-muted); }

    .topActions { flex: 0 0 auto; display:flex; gap:8px; }

    /* --- Botones --- */
    .btn {
      height: 32px;
      padding: 0 12px;
      border-radius: var(--radius-md);
      font-family: var(--font-sans);
      font-size: 13px;
      font-weight: 500;
      display: inline-flex; align-items: center; justify-content: center; gap: 6px;
      cursor: pointer;
      border: 1px solid var(--border);
      background: var(--surface-1);
      color: var(--text-main);
      transition: all 0.15s ease;
      white-space: nowrap;
    }
    .btn:hover:not(:disabled) { background: var(--surface-2); border-color: var(--border-hover); }
    .btn:active:not(:disabled) { transform: translateY(1px); }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }

    .btn.primary {
      background: var(--primary);
      border-color: var(--primary);
      color: var(--primary-fg);
      box-shadow: 0 1px 2px rgba(0,0,0,0.2);
    }
    .btn.primary:hover:not(:disabled) { background: var(--primary-hover); border-color: var(--primary-hover); }

    .btn.bad { color: var(--danger); background: transparent; border-color: transparent; }
    .btn.bad:hover { background: var(--danger-bg); }

    /* --- Selects & Inputs --- */
    .select, input[type="range"], textarea, input[type="text"] {
      height: 32px;
      border-radius: var(--radius-md);
      border: 1px solid var(--border);
      background: var(--bg);
      color: var(--text-main);
      padding: 0 10px;
      font-size: 12px;
      font-family: var(--font-sans);
    }
    .select:focus, textarea:focus, input[type="text"]:focus { border-color: var(--primary); }
    textarea { height: 80px; resize: vertical; padding: 8px 10px; line-height: 1.5; }


    input[type="range"] { padding: 0; height: 4px; appearance: none; background: var(--surface-3); border: none; }
    input[type="range"]::-webkit-slider-thumb {
      appearance: none; width: 14px; height: 14px; border-radius: 50%; background: var(--text-main); cursor: pointer;
    }

    /* --- Layout Principal --- */
    main {
      flex: 1;
      display: grid;
      grid-template-columns: 300px minmax(0, 1fr) 340px; 
      gap: 16px;
      padding: 16px;
      overflow: hidden; 
      min-height: 0;
    }
    
    @media (max-width: 1100px){ main { grid-template-columns: 1fr; overflow-y: auto; display:flex; flex-direction:column; } }

    /* --- Cards --- */
    .card {
      background: var(--surface-1);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      display: flex; flex-direction: column;
      overflow: hidden;
      box-shadow: var(--shadow);
      height: 100%;
      min-height: 0;
    }
    .cardTop {
      flex: 0 0 auto;
      padding: 10px 14px;
      border-bottom: 1px solid var(--border);
      background: var(--surface-1);
      display: flex; align-items: center; justify-content: space-between;
      min-height: 48px;
    }
    .cardTitle h2 { font-size: 13px; font-weight: 600; margin: 0; text-transform: uppercase; letter-spacing: 0.5px; }
    
    /* Scroll areas */
    .cardBody { 
      padding: 14px; 
      flex: 1; 
      overflow-y: auto; 
      display: flex; flex-direction: column; 
      min-height: 0; 
    }

    /* --- Izquierda: Lista --- */
    .dropzone {
      border: 1px dashed var(--border-hover);
      border-radius: var(--radius-lg);
      padding: 16px;
      text-align: center;
      background: var(--bg);
      transition: all .2s;
      margin-bottom: 12px;
      flex: 0 0 auto;
    }
    .dropzone.drag { border-color: var(--primary); background: rgba(99, 102, 241, 0.05); }
    
    .dropLeft { display: flex; flex-direction: column; align-items: center; gap: 6px; margin-bottom: 8px; }
    .spark {
      width: 32px; height: 32px; border-radius: 8px;
      background: var(--surface-2);
      display: flex; align-items: center; justify-content: center;
      color: var(--text-muted);
    }
    .dropText .a { font-weight: 500; font-size: 13px; color: var(--text-main); }
    .dropText .b { font-size: 11px; color: var(--text-muted); }
    input[type="file"]{ display: none; }

    .kpi {
      display: flex; align-items: center; gap: 8px;
      font-size: 12px; color: var(--text-muted);
      padding: 6px 10px;
      background: var(--surface-2);
      border-radius: var(--radius-md);
      margin-bottom: 8px;
      flex: 0 0 auto;
    }
    .kpi strong { color: var(--text-main); font-weight: 600; }

    .list { display: flex; flex-direction: column; gap: 4px; overflow-y: auto; flex: 1; min-height: 0; }
    .item {
      display: grid; grid-template-columns: 36px 1fr auto; gap: 10px;
      padding: 6px;
      border-radius: var(--radius-md);
      border: 1px solid transparent;
      cursor: pointer;
      transition: background .1s;
    }
    .item:hover { background: var(--surface-2); }
    .item.active { background: var(--surface-2); border-color: var(--primary); }
    
    .thumb { width: 36px; height: 36px; border-radius: 6px; overflow: hidden; background: black; }
    .thumb img { width: 100%; height: 100%; object-fit: cover; }
    
    .name { font-size: 12px; font-weight: 500; color: var(--text-main); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .sub { font-size: 10px; color: var(--text-dim); }
    .sub.warn { color: var(--warn); }
    
    .iconMini {
      width: 24px; height: 24px; border-radius: 6px;
      display: flex; align-items: center; justify-content: center;
      color: var(--text-muted); cursor: pointer;
      transition: all .2s; border: none; background: transparent;
    }
    .iconMini:hover { background: var(--danger-bg); color: var(--danger); }

    .empty {
      padding: 20px; text-align: center; color: var(--text-muted); font-size: 12px;
      border: 1px dashed var(--border); border-radius: var(--radius-lg); margin-top: 10px;
    }

    /* --- Centro: Editor --- */
    .centerCol {
      display: flex; flex-direction: column; height: 100%;
      overflow: hidden;
    }

    .editorToolbar {
      flex: 0 0 auto;
      margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center;
      background: var(--surface-1); padding: 6px 10px;
      border: 1px solid var(--border); border-radius: 8px;
    }

    .editorWrap {
      flex: 1;
      display: flex; flex-direction: column;
      background: #000;
      border-radius: var(--radius-sm);
      overflow: hidden;
      border: 1px solid var(--border);
      min-height: 0;
    }

    .editorTop {
      flex: 0 0 auto;
      background: var(--surface-2);
      padding: 6px 10px;
      border-bottom: 1px solid var(--border);
      display: flex; justify-content: space-between; align-items: center; gap: 8px; flex-wrap: wrap;
    }
    
    .toolGroup { display: flex; gap: 4px; align-items: center; }
    .label { font-size: 10px; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-dim); font-weight: 600; margin-right: 4px; }
    
    .editorCanvas {
      flex-grow: 1;
      height: 0; /* Force flex constraint */
      width: 100%;
      position: relative;
      background-image: 
        linear-gradient(45deg, #111 25%, transparent 25%), 
        linear-gradient(-45deg, #111 25%, transparent 25%), 
        linear-gradient(45deg, transparent 75%, #111 75%), 
        linear-gradient(-45deg, transparent 75%, #111 75%);
      background-size: 20px 20px;
      background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
      background-color: #050505;
      overflow: hidden; 
    }
    #image { display: block; max-width: 100%; }

    /* --- Derecha: Preview & Export --- */
    .cardBody.previewBody {
       justify-content: center;
       align-items: center;
    }
    
    .feed {
      width: 100%;
      max-width: 300px;
      border: 1px solid var(--border);
      border-radius: 16px;
      background: #000;
      overflow: hidden;
      box-shadow: 0 10px 30px -10px rgba(0,0,0,0.5);
      flex: 0 0 auto;
      margin-bottom: 16px;
    }
    .feedHead {
      height: 40px; padding: 0 12px; display: flex; align-items: center; gap: 8px;
      border-bottom: 1px solid #222;
    }
    .avatar { width: 20px; height: 20px; border-radius: 50%; background: linear-gradient(to right, #6366f1, #ec4899); }
    
    .media { 
        width: 100%; 
        position: relative; 
        background: #111; 
        min-height: 100px;
        display: flex; align-items: center; justify-content: center;
        transition: height 0.2s ease-out;
    }
    .media img { width: 100%; height: 100%; object-fit: contain; display: block; }
    
    .nav { position: absolute; inset: 0; display: flex; justify-content: space-between; align-items: center; padding: 10px; pointer-events: none; }
    .nav button {
      pointer-events: auto; width: 24px; height: 24px; border-radius: 50%;
      background: rgba(255,255,255,0.9); color: black; border: none;
      font-weight: bold; cursor: pointer; opacity: 0.8; font-size: 12px;
    }
    .nav button:hover { opacity: 1; transform: scale(1.1); }
    
    .dots {
      position: absolute; bottom: 10px; left: 50%; transform: translateX(-50%);
      display: flex; gap: 4px;
    }
    .dot { width: 5px; height: 5px; border-radius: 50%; background: rgba(255,255,255,0.3); transition: .2s; }
    .dot.active { background: #3b82f6; transform: scale(1.2); }

    .feedFoot { padding: 8px 12px; border-top: 1px solid #222; }

    /* √Årea de Caption */
    .captionArea {
        margin-bottom: 16px; border-top: 1px solid var(--border); padding-top: 12px; width: 100%;
    }
    .captionInput {
        width: 100%;
        height: 80px;
        background: var(--bg);
        border: 1px solid var(--border);
        border-radius: var(--radius-md);
        color: var(--text-main);
        padding: 8px;
        font-family: var(--font-sans);
        font-size: 12px;
        resize: vertical;
        margin-top: 4px;
    }
    .captionInput:focus { border-color: var(--primary); }

    .exportSection {
        width: 100%; border-top: 1px solid var(--border); padding-top: 12px; margin-top: auto;
    }

    /* --- Storyboard (Bottom) --- */
    .stripWrap {
      flex: 0 0 130px; 
      z-index: 30;
      background: var(--bg);
      border-top: 1px solid var(--border);
      padding: 0 16px 10px;
      display: flex; flex-direction: column;
    }
    .stripWrap .card {
      height: 100%; border-radius: var(--radius-lg) var(--radius-lg) 0 0; border-bottom: none;
    }
    .strip {
      display: flex; gap: 10px; overflow-x: auto; padding: 10px;
      background: var(--surface-1);
      align-items: center; height: 100%;
    }
    .frame {
      position: relative; flex: 0 0 auto;
      border: 2px solid transparent;
      border-radius: 6px; overflow: hidden;
      cursor: grab; transition: transform .1s, border-color .2s;
      background: #000;
      box-shadow: 0 4px 10px rgba(0,0,0,0.2);
    }
    .frame:hover { transform: translateY(-2px); border-color: var(--border-hover); }
    .frame.active { border-color: var(--primary); box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.3); }
    .frame.dragging { opacity: 0.4; }
    .frame.over { border: 2px dashed var(--primary); }
    
    .badge {
      position: absolute; top: 4px; left: 4px; padding: 2px 4px; border-radius: 3px;
      font-size: 9px; font-weight: 600;
      background: rgba(0,0,0,0.6); color: white; backdrop-filter: blur(4px);
    }

    /* --- Modal --- */
    .modalOverlay {
      position: fixed; inset: 0; z-index: 200;
      background: rgba(0,0,0,0.7); backdrop-filter: blur(4px);
      display: none; align-items: center; justify-content: center;
    }
    .modal {
      width: 380px; max-width: 90%;
      background: var(--surface-1);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1), 0 10px 10px -5px rgba(0,0,0,0.04);
      overflow: hidden;
      display: flex; flex-direction: column;
      max-height: 90vh;
    }
    .modalTop {
      padding: 14px; border-bottom: 1px solid var(--border);
      display: flex; justify-content: space-between; align-items: center;
      flex: 0 0 auto;
    }
    .modalBody { padding: 16px; overflow-y: auto; flex: 1; min-height: 0; }
    .modalActions { padding: 14px; background: var(--surface-2); border-top: 1px solid var(--border); display: flex; justify-content: flex-end; gap: 8px; flex: 0 0 auto; }

    /* Help Text Styles */
    .helpBlock { margin-bottom: 16px; border-bottom: 1px solid var(--surface-3); padding-bottom: 16px; }
    .helpBlock:last-child { border-bottom: none; }
    .helpBlock h4 { margin: 0 0 8px; color: var(--primary); font-size: 13px; font-weight: 700; text-transform: uppercase; }
    .helpBlock p { margin: 0 0 8px; color: var(--text-muted); font-size: 13px; line-height: 1.6; }
    .helpBlock ul, .helpBlock ol { margin: 0 0 8px; padding-left: 20px; color: var(--text-muted); font-size: 13px; }
    .helpBlock li { margin-bottom: 4px; }
    .codeBox { background: #000; padding: 8px; border-radius: 4px; font-family: monospace; color: #a5b4fc; word-break: break-all; font-size: 12px; }

    /* --- Utility Icons (SVG) --- */
    .i { width: 14px; height: 14px; display: inline-block; vertical-align: middle; }
    
    /* Scrollbars Elegantes */
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: var(--surface-3); border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: var(--border-hover); }

    /* --- CROPPER FIX DEFINITIVO (VISUAL) --- */
    .cropper-modal { background-color: #000 !important; opacity: 0.8 !important; }
    .cropper-view-box { outline: 1px solid var(--primary); background-color: transparent !important; display: block; overflow: hidden; width: 100%; height: 100%; }
    .cropper-face { background-color: transparent !important; }
    .cropper-view-box img { opacity: 1 !important; background: transparent !important; }
    .cropper-line, .cropper-point { background-color: var(--primary); }
    .cropper-container { width: 100% !important; height: 100% !important; }

    /* Animaci√≥n IA */
    @keyframes spin { 100% { transform: rotate(360deg); } }
    .spinning { animation: spin 1s linear infinite; display:inline-block; }
  </style>
</head>

<body>
<header>
  <div class="brand">
    <div class="logo">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <rect x="2" y="7" width="20" height="10" rx="2" ry="2"></rect>
        <path d="M12 7v10"></path>
      </svg>
    </div>
    <div class="titleWrap">
      <p class="title">CaruselForge</p>
    </div>
  </div>

  <div id="headerMsg"></div>

  <div class="topActions">
    <button class="btn" id="helpBtn" title="Instrucciones">Ayuda</button>
    <button class="btn" id="aiSettings" title="Configurar API Keys (OpenAI y Replicate)">‚öôÔ∏è AI</button>
    <button class="btn bad" id="clearAll" title="Vaciar todo">Vaciar</button>
  </div>
</header>

<main>
  <section class="card">
    <div class="cardTop">
      <div class="cardTitle">
        <h2>Im√°genes</h2>
      </div>
      <div style="display:flex; gap:6px">
         <button class="btn" id="moveUp" title="Subir" style="padding:0 8px">‚Üë</button>
         <button class="btn" id="moveDown" title="Bajar" style="padding:0 8px">‚Üì</button>
      </div>
    </div>

    <div class="cardBody">
      <label class="dropzone" id="dropzone" style="cursor:pointer">
        <input id="files" type="file" accept="image/*" multiple>
        <div class="dropLeft">
          <div class="spark">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
               <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
               <polyline points="17 8 12 3 7 8"></polyline>
               <line x1="12" y1="3" x2="12" y2="15"></line>
            </svg>
          </div>
          <div class="dropText">
            <div class="a">A√±adir fotos</div>
          </div>
        </div>
      </label>

      <div id="empty" class="empty" style="display:none">
        Arrastra tus im√°genes aqu√≠
      </div>

      <div class="kpi">
        <span>Fotos:</span> <strong id="count">0</strong>
        <span style="opacity:.3; margin:0 6px">|</span>
        <span style="white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:80px" id="selName">‚Äî</span>
      </div>

      <div class="list" id="list"></div>

      <div style="margin-top:10px; display:flex; gap:6px; flex: 0 0 auto;">
        <button class="btn" style="flex:1" id="prev">Ant</button>
        <button class="btn" style="flex:1" id="next">Sig</button>
      </div>
    </div>
  </section>

  <section class="card centerCol" style="border:none; background:transparent; box-shadow:none; overflow:hidden">
    <div class="editorToolbar">
        <div style="display:flex; align-items:center; gap:12px">
            <div class="kpi" style="margin:0; background:transparent; padding:0">
                <span class="label">Ratio Actual</span>
                <strong id="ratioLabel" style="font-size:13px">1:1</strong>
                <small id="ratioMode" style="color:var(--text-dim); margin-left:4px">(Libre)</small>
            </div>
        </div>
        <button class="btn" id="changeRatio" style="height:26px; font-size:11px">Configurar Todo</button>
    </div>

    <div class="editorWrap">
      <div class="editorTop">
        <div class="toolGroup">
          <span class="label">Ratios</span>
          <button class="btn" data-r="1" style="padding:0 8px">1:1</button>
          <button class="btn" data-r="4/5" style="padding:0 8px">4:5</button>
          <button class="btn" data-r="9/16" style="padding:0 8px">9:16</button>
          <button class="btn" data-r="3/2" style="padding:0 8px">3:2</button>
          <button class="btn" data-r="4/3" style="padding:0 8px">4:3</button>
        </div>
        
        <div class="toolGroup">
            <span class="label">IA Edit</span>
            <button class="btn primary" id="aiEditPromptBtn" title="Editor IA Independiente">‚ú® Editor IA</button>
        </div>
        <div class="toolGroup" style="margin-left:auto; margin-right:8px">
            <button class="btn" id="rotL" title="Rotar izq" style="padding:0 8px">‚ü≤</button>
            <button class="btn" id="rotR" title="Rotar der" style="padding:0 8px">‚ü≥</button>
            <button class="btn" id="zoomOut" title="Zoom -" style="padding:0 8px">‚àí</button>
            <button class="btn" id="zoomIn" title="Zoom +" style="padding:0 8px">+</button>
        </div>
        
        <div class="toolGroup">
            <button class="btn" id="reset">Reset</button>
            <button class="btn primary" id="saveCrop">Guardar</button>
        </div>
      </div>

      <div class="editorCanvas" id="editorCanvas">
        <img id="image" alt="">
      </div>
    </div>
  </section>

  <section class="card">
    <div class="cardTop">
      <div class="cardTitle">
        <h2>Vista Previa</h2>
      </div>
    </div>

    <div class="cardBody previewBody">
      <div class="feed">
        <div class="feedHead">
          <div class="avatar"></div>
          <div>
            <div style="height:8px; width:80px; background:#333; border-radius:4px; margin-bottom:4px"></div>
            <div style="height:6px; width:50px; background:#222; border-radius:4px"></div>
          </div>
        </div>

        <div class="media" id="media">
          <img id="preview" alt="">
          <div class="nav">
            <button id="pPrev">‚Äπ</button>
            <button id="pNext">‚Ä∫</button>
          </div>
          <div class="dots" id="dots"></div>
        </div>

        <div class="feedFoot">
             <div style="display:flex; gap:10px">
                 <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#ccc" stroke-width="2"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg>
                 <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#ccc" stroke-width="2"><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"></path></svg>
             </div>
        </div>
      </div>

      <div class="captionArea">
          <div style="display:flex; justify-content:space-between; margin-bottom:4px; align-items:flex-end">
            <label class="label">Texto para el post</label>
            <div style="display:flex; gap:8px; align-items:center">
                <button id="aiFixBtn" class="btn primary" style="height:20px; font-size:10px; padding:0 6px; display:none;">‚ú® Mejorar IA</button>
                <span id="charCount" style="font-size:10px; color:var(--text-dim)">0 / 2200</span>
            </div>
          </div>
          <textarea id="captionText" class="captionInput" placeholder="Escribe aqu√≠ tu copy..."></textarea>
      </div>

      <div class="exportSection">
          <h3 style="font-size:11px; text-transform:uppercase; color:var(--text-dim); margin:0 0 8px 0;">Exportar</h3>
          
          <div style="display:grid; grid-template-columns: 1fr 1fr; gap:8px; margin-bottom:8px">
              <div>
                  <label class="label">Tama√±o</label>
                  <select class="select" id="size" style="width:100%">
                    <option value="1080" selected>1080px</option>
                    <option value="2160">2160px (Hi-Res)</option>
                  </select>
              </div>
              <div>
                  <label class="label">Formato</label>
                  <select class="select" id="fmt" style="width:100%">
                    <option value="jpeg" selected>JPG</option>
                    <option value="png">PNG</option>
                  </select>
              </div>
          </div>
          
          <div style="margin-bottom:12px">
             <div style="display:flex; justify-content:space-between;">
                 <label class="label">Calidad</label>
                 <strong id="qVal" style="font-size:10px">0.95</strong>
             </div>
             <input id="q" type="range" min="0.80" max="1.00" step="0.01" value="0.95" style="width:100%">
          </div>

          <div style="display:flex; flex-direction:column; gap:6px">
              <button class="btn primary" id="dlZip" style="height:38px; width:100%">
                Descargar Todo (ZIP)
              </button>
              
              <div style="display:flex; gap:6px">
                 <button class="btn" id="dlOne" style="flex:1">Esta foto</button>
                 <button class="btn" id="exportCrop" title="Recorte exacto" style="width:36px; padding:0">‚úÇ</button>
              </div>
          </div>
      </div>
    </div>
  </section>
</main>

<div class="stripWrap">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:6px">
        <h3 style="font-size:11px; margin:0; color:var(--text-muted)">STORYBOARD</h3>
    </div>
    <div class="card" style="border-radius: var(--radius-lg); background:var(--surface-2)">
        <div class="strip" id="strip"></div>
    </div>
</div>

<div class="modalOverlay" id="modalOverlay">
  <div class="modal">
    <div class="modalTop">
      <b id="modalTitle">Ratio Global</b>
      <button class="btn" id="modalClose" style="border:none; background:transparent; padding:0; width:24px;">‚úï</button>
    </div>
    <div class="modalBody">
      <p style="color:var(--text-muted); margin-bottom:12px; font-size:13px">
        Aplica un formato √∫nico a todas las im√°genes.
      </p>
      <div style="display:flex; flex-direction:column; gap:6px">
        <select class="select" id="modalRatio" style="width:100%">
          <option value="1:1">1:1 (Cuadrado)</option>
          <option value="4:5">4:5 (Retrato)</option>
          <option value="9:16">9:16 (Story)</option>
          <option value="3:2">3:2 (Horizontal)</option>
          <option value="4:3">4:3 (Est√°ndar)</option>
          <option value="1.91:1">1.91:1 (Banner)</option>
        </select>
      </div>
    </div>
    <div class="modalActions">
      <button class="btn" id="modalCancel">Cancelar</button>
      <button class="btn primary" id="modalApply">Aplicar</button>
    </div>
  </div>
</div>

<div class="modalOverlay" id="aiConfigModalOverlay" style="z-index:230">
    <div class="modal" style="width:450px; max-width:95%">
        <div class="modalTop">
            <b>üîë Configuraci√≥n de Claves API</b>
            <button class="btn" id="aiConfigModalClose" style="border:none; background:transparent; padding:0; width:24px;">‚úï</button>
        </div>
        <div class="modalBody">
            <p style="color:var(--danger); font-weight:600;">
                ADVERTENCIA: Las claves API son credenciales secretas. Almacenarlas aqu√≠ las expone en el c√≥digo del navegador.
            </p>

            <div style="margin-bottom:15px">
                <label class="label">Clave API de OpenAI (Corrector de Texto)</label>
                <input type="text" id="openAiKeyInput" style="width:100%; height:38px; margin-top:4px;" placeholder="sk-..." />
            </div>

            <div>
                <label class="label">Clave API de Replicate (Editor de Imagen)</label>
                <input type="text" id="replicateKeyInput" style="width:100%; height:38px; margin-top:4px;" placeholder="r8_..." />
            </div>
            
        </div>
        <div class="modalActions">
            <button class="btn" id="aiConfigModalCancel">Cancelar</button>
            <button class="btn primary" id="aiConfigModalSave">Guardar Claves</button>
        </div>
    </div>
</div>
<div class="modalOverlay" id="aiEditModalOverlay" style="z-index:220">
  <div class="modal" style="width:650px; max-width:95%">
    <div class="modalTop">
      <b id="aiEditModalTitle">‚ú® Editor IA Independiente (Replicate)</b>
      <button class="btn" id="aiEditModalClose" style="border:none; background:transparent; padding:0; width:24px;">‚úï</button>
    </div>
    <div class="modalBody" style="display:flex; flex-direction:column; gap:16px;">
      
      <p style="color:var(--danger); font-weight:600; font-size:13px">
        Este m√≥dulo no edita el carrusel activo. Procesa la imagen y te permite descargar el resultado.
      </p>

      <div style="display:grid; grid-template-columns: 1fr 1fr; gap:16px;">
        <div>
            <label class="label" style="margin-bottom:8px;">1. Imagen y Prompt</label>
            <label class="dropzone" id="aiDropzone" style="cursor:pointer; padding:12px">
                <input id="aiFileInput" type="file" accept="image/*">
                <div style="font-size:13px; font-weight:500; color:var(--text-main)" id="aiFileLabel">
                    Arrastra aqu√≠ o haz click para seleccionar una foto.
                </div>
            </label>

            <label class="label" style="margin-top:12px;">Instrucci√≥n / Prompt</label>
            <textarea id="aiEditPromptInput" class="captionInput" style="height:80px; margin-top:4px;" placeholder="Ej: Quita la persona que est√° al fondo y mejora la iluminaci√≥n."></textarea>
            
            <button class="btn primary" id="aiModalProcessBtn" style="width:100%; margin-top:12px;" disabled>
                Procesar Imagen con IA
            </button>
        </div>

        <div>
            <label class="label">2. Resultado</label>
            <div id="aiPreviewWrap" style="height:250px; background:var(--bg); border:1px solid var(--border); border-radius:8px; display:flex; align-items:center; justify-content:center; margin-top:4px; overflow:hidden">
                <img id="aiPreviewImg" src="" alt="Resultado IA" style="max-width:100%; max-height:100%; display:none; object-fit:contain;">
                <span id="aiPlaceholder" style="color:var(--text-muted); font-size:12px;">Esperando procesamiento...</span>
            </div>
            
            <button class="btn success" id="aiModalDownloadBtn" style="width:100%; margin-top:12px;" disabled>
                ‚Üì Descargar Resultado (JPG)
            </button>
        </div>
      </div>
      
    </div>
    <div class="modalActions">
      <small style="color:var(--text-dim); margin-right:auto;">Modelo: bytedance/seedream-4. Requiere clave de Replicate en ‚öôÔ∏è AI.</small>
      <button class="btn primary" id="aiEditModalCancel">Cerrar</button>
    </div>
  </div>
</div>
<div class="modalOverlay" id="helpOverlay" style="z-index:210">
  <div class="modal" style="width:600px; max-width:95%">
    <div class="modalTop">
      <b>üìö Instrucciones & API Guide</b>
      <button class="btn" id="helpCloseBtn" style="border:none; background:transparent; padding:0; width:24px;">‚úï</button>
    </div>
    <div class="modalBody">
      <div class="helpBlock">
        <h4>1. Flujo de Trabajo</h4>
        <ul>
            <li><b>Sube im√°genes:</b> Arrastra archivos o usa el bot√≥n "A√±adir".</li>
            <li><b>Edita:</b> Ajusta el recorte. Puedes usar un ratio libre o forzar el 4:5 (Instagram).</li>
            <li>**Editor IA:** Usa el bot√≥n "‚ú® Editor IA" para un m√≥dulo separado donde puedes subir una foto, editarla con un prompt y descargar el resultado.</li>
            <li><b>Ordena:</b> Arrastra las fotos en el "Storyboard" inferior para cambiar el orden.</li>
            <li><b>Exporta:</b> Descarga un ZIP con todas las im√°genes listas para publicar.</li>
        </ul>
      </div>

      <div class="helpBlock">
        <h4>2. Configuraci√≥n de la IA (OpenAI y Replicate)</h4>
        <p>Usa el bot√≥n <b>‚öôÔ∏è AI</b> para ingresar tus claves de OpenAI (texto) y Replicate (imagen). Ambas son necesarias para las funciones de IA.</p>
        <p style="color:var(--danger); font-weight:600;">‚ö†Ô∏è ADVERTENCIA: Las claves son secretas y se exponen al guardarlas en tu navegador.</p>
      </div>
      
      <div class="helpBlock">
        <h4>3. Modelo de Replicate Usado</h4>
        <p>La edici√≥n de imagen utiliza el modelo <code>bytedance/seedream-4</code>.</p>
      </div>
    </div>
    <div class="modalActions">
      <button class="btn primary" id="helpOkBtn">Entendido</button>
    </div>
  </div>
</div>

<script>
(() => {
  const $ = (id) => document.getElementById(id);

  // Elementos principales y UI
  const files = $('files');
  const list = $('list');
  const strip = $('strip');
  const img = $('image');
  const editorCanvas = $('editorCanvas');

  const preview = $('preview');
  const media = $('media');
  const dots = $('dots');

  const prevBtn = $('prev');
  const nextBtn = $('next');
  const pPrev = $('pPrev');
  const pNext = $('pNext');

  const clearAll = $('clearAll');
  const moveUp = $('moveUp');
  const moveDown = $('moveDown');

  const zoomIn = $('zoomIn');
  const zoomOut = $('zoomOut');
  const rotL = $('rotL');
  const rotR = $('rotR');
  const reset = $('reset');
  const saveCrop = $('saveCrop');

  const sizeEl = $('size');
  const fmt = $('fmt');
  const q = $('q');
  const qVal = $('qVal');

  const dlOne = $('dlOne');
  const dlZip = $('dlZip');
  const exportCropBtn = $('exportCrop');

  // Caption & AI
  const captionText = $('captionText');
  const charCount = $('charCount');
  const aiSettingsBtn = $('aiSettings');
  const aiFixBtn = $('aiFixBtn');

  const countEl = $('count');
  const selNameEl = $('selName');
  const ratioLabel = $('ratioLabel');
  const ratioMode = $('ratioMode');

  const dropzone = $('dropzone');
  const headerMsg = $('headerMsg'); 
  const empty = $('empty');

  // Modal Ratios
  const changeRatioBtn = $('changeRatio');
  const modalOverlay = $('modalOverlay');
  const modalClose = $('modalClose');
  const modalCancel = $('modalCancel');
  const modalApply = $('modalApply');
  const modalRatio = $('modalRatio');

  // Modal Help
  const helpBtn = $('helpBtn');
  const helpOverlay = $('helpOverlay');
  const helpCloseBtn = $('helpCloseBtn');
  const helpOkBtn = $('helpOkBtn');

  // MODALES Y CLAVES AI
  const aiEditPromptBtn = $('aiEditPromptBtn');
  const aiEditModalOverlay = $('aiEditModalOverlay');
  const aiEditModalClose = $('aiEditModalClose');
  const aiEditModalCancel = $('aiEditModalCancel');
  const aiEditPromptInput = $('aiEditPromptInput');
  const aiConfigModalOverlay = $('aiConfigModalOverlay');
  const aiConfigModalClose = $('aiConfigModalClose');
  const aiConfigModalCancel = $('aiConfigModalCancel');
  const aiConfigModalSave = $('aiConfigModalSave');
  const openAiKeyInput = $('openAiKeyInput');
  const replicateKeyInput = $('replicateKeyInput');

  // NUEVOS ELEMENTOS Y ESTADO para el Editor Independiente
  const aiDropzone = $('aiDropzone');
  const aiFileInput = $('aiFileInput');
  const aiFileLabel = $('aiFileLabel');
  const aiPreviewWrap = $('aiPreviewWrap');
  const aiPreviewImg = $('aiPreviewImg');
  const aiPlaceholder = $('aiPlaceholder');
  const aiModalProcessBtn = $('aiModalProcessBtn');
  const aiModalDownloadBtn = $('aiModalDownloadBtn');
  
  let standaloneInputDataUrl = null; // Base64 de la imagen de entrada
  let standaloneOutputUrl = null; // URL del resultado de Replicate


  // Config Ratios
  const RATIOS = [
    { key:'1:1', value:1,      out:(s)=>({w:s,h:s}) },
    { key:'4:5', value:4/5,    out:(s)=>({w:s,h: Math.round(s*5/4)}) },
    { key:'9:16', value:9/16,  out:(s)=>({w:s,h: Math.round(s*16/9)}) },
    { key:'3:2', value:3/2,    out:(s)=>({w:s,h: Math.round(s*2/3)}) },
    { key:'4:3', value:4/3,    out:(s)=>({w:s,h: Math.round(s*3/4)}) },
    { key:'1.91:1', value:1.91,out:(s)=>({w:s,h: Math.round(s/1.91)}) },
  ];
  const keyFromValue = (v) => RATIOS.map(r=>({k:r.key,d:Math.abs(r.value-v)})).sort((a,b)=>a.d-b.d)[0]?.k || '1:1';
  const valueFromKey = (k) => RATIOS.find(r=>r.key===k)?.value ?? 1;
  const outDims = (k, base) => (RATIOS.find(r=>r.key===k)?.out ?? ((s)=>({w:s,h:s})))(base);

  // Estado
  let items = []; 
  let selected = -1;
  let cropper = null;
  let currentRatio = 1;
  let dragFrom = null;
  let busyZip = false;
  let carouselRatioKey = null;
  let toastTimer = null;
  
  // AI Key Storage (Separated)
  let openAiKey = localStorage.getItem('carusel_ai_key_openai') || '';
  let replicateKey = localStorage.getItem('carusel_ai_key_replicate') || '';


  const pad2 = (n)=> String(n).padStart(2,'0');

  function toast(type, title, msg){
    if(toastTimer) clearTimeout(toastTimer);
    headerMsg.className = type || 'info';
    headerMsg.textContent = `${title} ${msg ? '‚Äî ' + msg : ''}`;
    headerMsg.style.opacity = '1';
    toastTimer = setTimeout(()=>{
      headerMsg.style.opacity = '0';
    }, 3000);
  }

  // --- L√ìGICA DE CONFIGURACI√ìN DE AI ---

  function updateAiUi() {
      // Mostrar bot√≥n de edici√≥n de texto solo si hay clave de OpenAI
      aiFixBtn.style.display = openAiKey ? 'inline-flex' : 'none';
      
      // Resaltar el icono de settings si al menos una clave est√° presente
      if(openAiKey || replicateKey) aiSettingsBtn.classList.add('primary');
      else aiSettingsBtn.classList.remove('primary');

      // Deshabilitar el bot√≥n de edici√≥n si no hay clave de Replicate (en el editor principal, aunque no se use)
      // En este caso, lo dejamos activado para que el usuario pueda abrir el modal independiente si quiere.
      // aiEditPromptBtn.disabled = !replicateKey; 
  }

  function openAiConfigModal() {
      openAiKeyInput.value = openAiKey;
      replicateKeyInput.value = replicateKey;
      aiConfigModalOverlay.style.display = 'flex';
  }

  function saveAiKeys() {
      openAiKey = openAiKeyInput.value.trim();
      replicateKey = replicateKeyInput.value.trim();

      localStorage.setItem('carusel_ai_key_openai', openAiKey);
      localStorage.setItem('carusel_ai_key_replicate', replicateKey);
      
      aiConfigModalOverlay.style.display = 'none';
      updateAiUi();
      
      let msg = '';
      if(openAiKey && replicateKey) msg = 'OpenAI y Replicate guardadas.';
      else if (openAiKey) msg = 'Solo OpenAI guardada.';
      else if (replicateKey) msg = 'Solo Replicate guardada.';
      else msg = 'Todas las claves eliminadas.';
      
      toast('ok', 'Configuraci√≥n AI', msg);
  }

  aiSettingsBtn.addEventListener('click', openAiConfigModal);
  aiConfigModalSave.addEventListener('click', saveAiKeys);
  [aiConfigModalClose, aiConfigModalCancel].forEach(btn => {
      btn.addEventListener('click', () => { aiConfigModalOverlay.style.display = 'none'; });
  });


  // --- L√ìGICA DE EDICI√ìN DE TEXTO (OpenAI) ---

  async function fixCaptionWithAI() {
      const text = captionText.value.trim();
      if (!text) return toast('warn', 'Texto vac√≠o', 'Escribe algo primero.');
      if (!openAiKey) return toast('bad', 'Sin OpenAI Key', 'Config√∫rala en ‚öôÔ∏è AI.');

      const originalText = aiFixBtn.innerHTML;
      aiFixBtn.disabled = true;
      aiFixBtn.innerHTML = '<span class="spinning">‚Üª</span> Pensando...';

      try {
          const response = await fetch('https://api.openai.com/v1/chat/completions', {
              method: 'POST',
              headers: {
                  'Content-Type': 'application/json',
                  'Authorization': `Bearer ${openAiKey}`
              },
              body: JSON.stringify({
                  model: "gpt-4o-mini",
                  messages: [
                      {
                          role: "system",
                          content: "Eres un experto copywriter para Instagram. Tu tarea es corregir la ortograf√≠a, gram√°tica y mejorar ligeramente el estilo del texto proporcionado para que tenga mejor 'engagement'. Mant√©n la longitud similar. Devuelve SOLO el texto corregido."
                      },
                      { role: "user", content: text }
                  ],
                  temperature: 0.7
              })
          });

          const data = await response.json();
          if (data.error) throw new Error(data.error.message);

          const newText = data.choices[0].message.content;
          captionText.value = newText;
          
          const len = newText.length;
          charCount.textContent = `${len} / 2200`;
          
          toast('ok', 'IA', 'Texto mejorado exitosamente.');

      } catch (err) {
          console.error(err);
          toast('bad', 'Error IA', 'Revisa la consola o tu Key de OpenAI.');
      } finally {
          aiFixBtn.disabled = false;
          aiFixBtn.innerHTML = originalText;
      }
  }

  aiFixBtn.addEventListener('click', fixCaptionWithAI);
  
  // --- L√ìGICA DE EDICI√ìN DE IMAGEN (REPLICATE - STANDALONE) ---
  
  function openStandaloneAIEditor() {
    if (!replicateKey) return toast('bad', 'Clave Faltante', 'Configura tu clave de Replicate en ‚öôÔ∏è AI.');
    
    // Resetear estado del modal
    aiEditModalOverlay.style.display = 'flex';
    aiEditPromptInput.value = '';
    aiFileLabel.textContent = 'Arrastra aqu√≠ o haz click para seleccionar una foto.';
    aiPreviewImg.style.display = 'none';
    aiPlaceholder.style.display = 'inline';
    aiPlaceholder.textContent = 'Esperando procesamiento...';
    aiModalDownloadBtn.disabled = true;
    aiModalProcessBtn.disabled = true;
    standaloneInputDataUrl = null;
    standaloneOutputUrl = null;
    aiFileInput.value = ''; // Limpiar input file
  }
  
  // Manejo de la subida de imagen al m√≥dulo
  aiFileInput.addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (file && file.type.startsWith('image/')) {
        const reader = new FileReader();
        reader.onload = (e) => {
            standaloneInputDataUrl = e.target.result; // Almacena el Base64
            aiFileLabel.textContent = `Foto seleccionada: ${file.name}`;
            aiModalProcessBtn.disabled = false;
            aiModalDownloadBtn.disabled = true;
            aiPreviewImg.style.display = 'none';
            aiPlaceholder.style.display = 'inline';
            aiPlaceholder.textContent = 'Listo para procesar.';
        };
        reader.readAsDataURL(file);
    } else {
        toast('warn', 'Archivo', 'Por favor, selecciona una imagen.');
        aiModalProcessBtn.disabled = true;
        standaloneInputDataUrl = null;
    }
  });

  // Manejo de Drag and Drop del m√≥dulo IA
  const stopDrag = (e)=>{ e.preventDefault(); e.stopPropagation(); };
  ['dragenter','dragover'].forEach(ev=>{
    aiDropzone.addEventListener(ev, (e)=>{ stopDrag(e); aiDropzone.classList.add('drag'); });
  });
  ['dragleave','drop'].forEach(ev=>{
    aiDropzone.addEventListener(ev, (e)=>{ stopDrag(e); aiDropzone.classList.remove('drag'); });
  });
  aiDropzone.addEventListener('drop', (e)=>{
    const dt = e.dataTransfer;
    if(dt?.files?.length) {
        aiFileInput.files = dt.files;
        aiFileInput.dispatchEvent(new Event('change')); // Ejecuta la l√≥gica de carga
    }
  });


  async function processStandaloneImage(prompt) {
      if (!standaloneInputDataUrl) return toast('warn', 'Faltante', 'Sube una imagen primero.');
      if (!replicateKey) return toast('bad', 'Sin Replicate Key', 'Config√∫rala en ‚öôÔ∏è AI.');
      if (prompt.length < 5) return toast('warn', 'Prompt', 'Escribe una instrucci√≥n m√°s detallada.');

      // 1. Deshabilitar y mostrar estado de carga
      const btn = aiModalProcessBtn;
      const originalText = btn.innerHTML;
      btn.disabled = true;
      aiModalDownloadBtn.disabled = true;
      aiPlaceholder.textContent = 'Procesando en Replicate... (puede tardar)';
      aiPlaceholder.classList.add('spinning');
      aiPreviewImg.style.display = 'none';
      aiPlaceholder.style.display = 'inline';
      toast('info', 'Replicate IA', 'Enviando imagen a IA...');

      try {
          // 2. Petici√≥n DIRECTA a la API de Replicate
          const apiResponse = await fetch('https://api.replicate.com/v1/models/bytedance/seedream-4/predictions', { 
              method: 'POST',
              headers: { 
                  'Content-Type': 'application/json',
                  'Authorization': `Token ${replicateKey}`, 
                  'Prefer': 'wait' 
              },
              body: JSON.stringify({
                  input: {
                      prompt: prompt,
                      image_input: [standaloneInputDataUrl], // Imagen de entrada Base64
                      size: "2K",
                      aspect_ratio: "match_input_image",
                      enhance_prompt: true,
                      max_images: 1,
                      sequential_image_generation: "disabled"
                  }
              })
          });

          const result = await apiResponse.json();

          if (!apiResponse.ok) {
               // Errores de API (4xx, 5xx)
               const errorMsg = result.detail || result.error || 'Error de API o autenticaci√≥n con Replicate. Verifica tu clave.';
               throw new Error(errorMsg);
          }

          if (!result.output || result.output.length === 0) {
              throw new Error('Replicate no devolvi√≥ una imagen v√°lida. Intenta un prompt diferente.');
          }
          
          standaloneOutputUrl = result.output[0]; // Guarda la URL externa
          
          // 3. Mostrar resultado y habilitar descarga
          aiPreviewImg.src = standaloneOutputUrl;
          aiPreviewImg.style.display = 'block';
          aiPlaceholder.style.display = 'none';
          aiModalDownloadBtn.disabled = false;
          toast('ok', 'Replicate IA', 'Edici√≥n completada. Listo para descargar.');
          

      } catch (err) {
          console.error('Error de Replicate:', err);
          aiPlaceholder.textContent = 'ERROR. Revisa la consola o tu clave.';
          toast('bad', 'Error Replicate', err.message || 'Error desconocido.');
      } finally {
          // 4. Restaurar el bot√≥n
          aiPlaceholder.classList.remove('spinning');
          btn.disabled = false;
          btn.innerHTML = originalText;
      }
  }

  // Descarga del m√≥dulo independiente
  aiModalDownloadBtn.addEventListener('click', async () => {
      if (!standaloneOutputUrl) return;

      try {
          // Descargar la imagen
          const fetchResponse = await fetch(standaloneOutputUrl); 
          const blob = await fetchResponse.blob();
          
          // Usar la funci√≥n de descarga existente
          downloadBlob(blob, `AI_Edit_${new Date().getTime()}.jpg`);
          toast('ok', 'Descargando', 'Imagen IA guardada.');
          
      } catch (e) {
          console.error("Error de descarga:", e);
          toast('bad', 'Error de Descarga', 'No se pudo descargar. Puede ser un error CORS.');
      }
  });


  // Eventos del Modal de Edici√≥n IA
  aiEditPromptBtn.addEventListener('click', openStandaloneAIEditor);

  aiModalProcessBtn.addEventListener('click', () => {
      const prompt = aiEditPromptInput.value.trim();
      processStandaloneImage(prompt);
  });

  [aiEditModalClose, aiEditModalCancel].forEach(btn => {
      btn.addEventListener('click', () => { aiEditModalOverlay.style.display = 'none'; });
  });

  // ------------------------------------


  // --- MAIN APP LOGIC (Corregido el bug de carga) ---

  function destroyCropper(){
    if(cropper){ cropper.destroy(); cropper=null; }
  }

  async function getMeta(url){
    return new Promise((resolve, reject)=>{
      const im = new Image();
      im.onload = ()=> resolve({w:im.naturalWidth,h:im.naturalHeight});
      im.onerror = reject;
      im.src = url;
    });
  }

  function toggleEmpty(){
    empty.style.display = (items.length===0) ? 'block' : 'none';
  }

  function updateRatioModeUI(){
    ratioMode.textContent = carouselRatioKey ? `(Bloqueado)` : `(Libre)`;
    changeRatioBtn.disabled = items.length===0;
  }

  function lockCarouselRatioIfNeeded(ratioKey){
    if(!carouselRatioKey){
      carouselRatioKey = ratioKey;
      updateRatioModeUI();
      toast('ok','Ratio fijado', `${carouselRatioKey} para todas.`);
    }
  }

  function applyCarouselRatio(ratioKey){
    carouselRatioKey = ratioKey;
    currentRatio = valueFromKey(carouselRatioKey);
    items.forEach(it => {
      it.ratioKey = null;
      it.cropData = null;
      it.thumbDataUrl = null;
    });
    updateRatioModeUI();
    renderAll();
    if(selected>=0){
      select(selected);
      toast('ok', 'Ratio aplicado', `Todo en ${carouselRatioKey}.`);
    } else {
      toast('ok', 'Ratio aplicado', `Carrusel en ${carouselRatioKey}.`);
    }
  }

  function openModal(){
    modalOverlay.style.display = 'flex';
    modalRatio.value = carouselRatioKey || keyFromValue(currentRatio);
  }
  function closeModal(){
    modalOverlay.style.display = 'none';
  }

  async function addFiles(fileList){
    const fs = Array.from(fileList).filter(f=>f.type.startsWith('image/'));
    if(!fs.length) return;

    for(const f of fs){
      const url = URL.createObjectURL(f);
      await getMeta(url).catch(()=>({w:0,h:0}));
      items.push({ name: f.name || '', url, ratioKey: null, cropData: null, thumbDataUrl: null });
    }

    if(selected===-1) selected = 0;
    renderAll();
    select(selected);
    updatePreview();
    toggleEmpty();
    toast('ok', 'Fotos a√±adidas', `${fs.length} archivo(s).`);
  }

  function updateHeader(){
    countEl.textContent = String(items.length);
    const it = items[selected];
    selNameEl.textContent = it ? (it.name || `IMG_${pad2(selected+1)}`) : '‚Äî';
  }

  function setDisabled(){
    const has = items.length>0;
    const sel = selected>=0 && selected<items.length;
    [prevBtn,nextBtn,pPrev,pNext].forEach(b=> b.disabled = (items.length<=1));
    moveUp.disabled = !sel || selected===0;
    moveDown.disabled = !sel || selected===items.length-1;
    dlZip.disabled = !has || busyZip;
    dlOne.disabled = !sel;
    exportCropBtn.disabled = !sel;
    [saveCrop,zoomIn,zoomOut,rotL,rotR,reset].forEach(b=> b.disabled = !sel);
    clearAll.disabled = !has;
    const ratiosLocked = !!carouselRatioKey;
    document.querySelectorAll('[data-r]').forEach(b => {
      b.disabled = !sel || ratiosLocked;
    });
    changeRatioBtn.disabled = !has;
    updateAiUi(); // Actualiza el estado del bot√≥n de Replicate
  }

  function renderList(){
    list.innerHTML = '';
    items.forEach((it, i) => {
      const row = document.createElement('div');
      row.className = 'item' + (i===selected ? ' active':'');
      const th = document.createElement('div');
      th.className = 'thumb';
      const ti = document.createElement('img');
      ti.src = it.thumbDataUrl || it.url;
      th.appendChild(ti);
      const meta = document.createElement('div');
      meta.className = 'meta';
      meta.style.display = 'flex';
      meta.style.flexDirection = 'column';
      meta.style.justifyContent = 'center';
      meta.style.overflow = 'hidden';
      const n = document.createElement('div');
      n.className = 'name';
      n.textContent = `${pad2(i+1)}. ` + (it.name || `Imagen ${pad2(i+1)}`);
      const s = document.createElement('div');
      const shownRatio = carouselRatioKey || it.ratioKey;
      if(items.length && carouselRatioKey && it.ratioKey && it.ratioKey !== carouselRatioKey){
        s.className = 'sub warn';
        s.textContent = `‚ö† ${it.ratioKey}`;
      } else {
        s.className = 'sub';
        s.textContent = shownRatio ? `${shownRatio}` : 'Auto';
      }
      meta.appendChild(n); meta.appendChild(s);
      const del = document.createElement('button');
      del.className = 'iconMini';
      del.innerHTML = '‚úï';
      del.addEventListener('click', (e) => { e.stopPropagation(); remove(i); });
      row.appendChild(th);
      row.appendChild(meta);
      row.appendChild(del);
      row.addEventListener('click', ()=> select(i));
      list.appendChild(row);
    });
    updateHeader();
    setDisabled();
  }

  function renderStrip(){
    strip.innerHTML = '';
    if(items.length===0) return;
    items.forEach((it, i) => {
      const ratioKey = carouselRatioKey || it.ratioKey || keyFromValue(currentRatio);
      const r = valueFromKey(ratioKey);
      const frame = document.createElement('div');
      frame.className = 'frame' + (i===selected ? ' active':'');
      frame.draggable = true;
      frame.dataset.index = String(i);
      const W = 80; 
      const H = Math.max(40, Math.round(W / r));
      frame.style.height = H + 'px';
      frame.style.width = W + 'px';
      const im = document.createElement('img');
      im.src = it.thumbDataUrl || it.url;
      im.style.width='100%'; im.style.height='100%'; im.style.objectFit='cover'; im.style.display='block';
      const b1 = document.createElement('div');
      b1.className = 'badge';
      b1.textContent = pad2(i+1);
      frame.addEventListener('click', ()=> select(i));
      frame.addEventListener('dragstart', (e)=>{
        dragFrom = i;
        frame.classList.add('dragging');
        e.dataTransfer.effectAllowed = 'move';
        try { e.dataTransfer.setData('text/plain', String(i)); } catch {}
      });
      frame.addEventListener('dragend', ()=>{
        dragFrom = null;
        frame.classList.remove('dragging');
        strip.querySelectorAll('.frame.over').forEach(el=> el.classList.remove('over'));
      });
      frame.addEventListener('dragover', (e)=>{
        e.preventDefault();
        frame.classList.add('over');
        e.dataTransfer.dropEffect = 'move';
      });
      frame.addEventListener('dragleave', ()=> frame.classList.remove('over'));
      frame.addEventListener('drop', (e)=>{
        e.preventDefault();
        frame.classList.remove('over');
        const from = dragFrom ?? Number(e.dataTransfer.getData('text/plain'));
        const to = i;
        if(!Number.isFinite(from) || from===to) return;
        reorder(from, to);
        toast('', 'Movido', `a posici√≥n ${pad2(to+1)}.`);
      });
      frame.appendChild(im);
      frame.appendChild(b1);
      strip.appendChild(frame);
    });
  }

  function renderAll(){
    renderList();
    renderStrip();
    toggleEmpty();
    updateRatioModeUI();
  }

  function reorder(from, to){
    if(from<0 || to<0 || from>=items.length || to>=items.length) return;
    const moved = items.splice(from, 1)[0];
    items.splice(to, 0, moved);
    if(selected === from) selected = to;
    else if(from < selected && selected <= to) selected -= 1;
    else if(to <= selected && selected < from) selected += 1;
    renderAll();
    updatePreview();
  }

  function remove(i){
    if(i<0||i>=items.length) return;
    const name = items[i]?.name || `IMG_${pad2(i+1)}`;
    URL.revokeObjectURL(items[i].url);
    items.splice(i,1);
    if(items.length===0){
      selected=-1;
      destroyCropper();
      preview.src='';
      dots.innerHTML='';
      img.removeAttribute('src'); // Limpiar src
      ratioLabel.textContent = '1:1';
      captionText.value = '';
      charCount.textContent = '0 / 2200';
      carouselRatioKey = null;
      currentRatio = 1;
      renderAll();
      toast('warn', 'Vac√≠o', 'Sube fotos.');
      return;
    }
    selected = Math.min(selected, items.length-1);
    select(selected);
    renderAll();
    updatePreview();
    toast('bad', 'Eliminada', name);
  }

  function syncPreviewRealTime() {
    if(!cropper) return;
    const canvas = cropper.getCroppedCanvas({
        width: 400,
        imageSmoothingQuality: 'medium'
    });
    if(!canvas) return;
    preview.src = canvas.toDataURL('image/jpeg', 0.8);
    
    const feedContainer = document.querySelector('.feed');
    if(feedContainer) {
        const w = feedContainer.clientWidth;
        const aspect = canvas.width / canvas.height;
        media.style.height = Math.round(w / aspect) + 'px';
    }
  }

  // --- FIXED CROPPER INIT ---
  function initCropper(restoreConfig = null){
    destroyCropper();
    
    cropper = new Cropper(img, {
      viewMode: 1, 
      dragMode: 'move',
      autoCropArea: 1,
      background: false,
      zoomOnWheel: false, 
      movable: true,
      rotatable: true,
      scalable: false,
      cropBoxMovable: true,
      cropBoxResizable: true,
      checkCrossOrigin: false,
      // Aplicar el ratio correcto desde el inicio
      aspectRatio: restoreConfig ? restoreConfig.ratio : (currentRatio || NaN),
      
      ready: function() {
        // Restaurar datos solo cuando est√© listo
        if(restoreConfig && restoreConfig.data){
            this.cropper.setData(restoreConfig.data);
        }
        syncPreviewRealTime(); 
      },
      cropend: function() { syncPreviewRealTime(); },
      zoom: function() { setTimeout(syncPreviewRealTime, 100); }
    });
  }

  // --- FIXED SELECTION LOGIC (Correcci√≥n del bug de carga) ---
  function select(i){
    if(i < 0 || i >= items.length) return;
    
    // 1. Destruir instancia previa antes de cambiar nada
    destroyCropper();
    
    selected = i;
    const it = items[selected];
    
    // UI Updates
    const ratioKey = carouselRatioKey || it.ratioKey || keyFromValue(currentRatio);
    ratioLabel.textContent = ratioKey;
    updateHeader();

    // 2. Limpiar imagen previa del DOM
    img.removeAttribute('src');
    
    // 3. Asignar nueva imagen
    img.src = it.url;
    
    const handleImageLoad = () => {
        let targetRatio = currentRatio;
        
        // Determinar ratio
        if(carouselRatioKey){
            targetRatio = valueFromKey(carouselRatioKey);
        } else if(it.ratioKey){
            targetRatio = valueFromKey(it.ratioKey);
        }
        
        currentRatio = targetRatio;

        // 4. Iniciar con configuraci√≥n de restauraci√≥n
        initCropper({
            ratio: targetRatio,
            data: it.cropData 
        });
        
        renderAll();
        buildDots();
        // Limpiar el evento para evitar doble ejecuci√≥n si la imagen se carga dos veces
        img.onload = null;
    };
    
    img.onload = handleImageLoad;
    
    // APLICAR CORRECCI√ìN DE BUG: Si la imagen ya est√° cargada (por cach√© o sync), 
    // ejecutar la l√≥gica de inicializaci√≥n manualmente.
    if (img.complete && img.naturalWidth !== 0) {
        handleImageLoad(); 
    }
  }


  function moveSelection(dir){
    if(items.length<=1) return;
    selected = (selected + dir + items.length) % items.length;
    select(selected);
  }

  function moveItem(dir){
    if(selected<0) return;
    const ni = selected + dir;
    if(ni<0 || ni>=items.length) return;
    reorder(selected, ni);
  }

  function buildDots(){
    dots.innerHTML='';
    items.forEach((_,i)=>{
      const d=document.createElement('div');
      d.className='dot'+(i===selected?' active':'');
      dots.appendChild(d);
    });
  }

  function updatePreview(){
    if(items.length===0 || selected<0) { setDisabled(); return; }
    // Si no hay cropper activo (carga inicial), usamos thumb
    if(!cropper) {
        const it = items[selected];
        const ratioKey = carouselRatioKey || keyFromValue(currentRatio);
        const r = valueFromKey(ratioKey);
        const feedContainer = document.querySelector('.feed');
        const w = feedContainer ? feedContainer.clientWidth : 320;
        media.style.height = Math.round(w / r) + 'px';
        preview.src = it.thumbDataUrl || it.url;
    }
    const ratioKey = carouselRatioKey || keyFromValue(currentRatio);
    ratioLabel.textContent = ratioKey;
    buildDots();
    setDisabled();
    renderStrip();
    renderList();
  }
  
  const feedContainer = document.querySelector('.feed');
  if(feedContainer) {
      new ResizeObserver(() => {
          if(cropper) syncPreviewRealTime();
          else requestAnimationFrame(updatePreview);
      }).observe(feedContainer);
  }

  // --- FIXED SAVE LOGIC ---
  async function saveCurrentCrop(){
    const it = items[selected];
    if(!it || !cropper) return;

    // Si no hay bloqueo global, bloqueamos al guardar para consistencia
    if(!carouselRatioKey){
       const rk = keyFromValue(currentRatio);
       carouselRatioKey = rk; 
       updateRatioModeUI();
       toast('info', 'Ratio Fijado', `Carrusel ajustado a ${rk}`);
    }

    // Guardar datos
    it.cropData = cropper.getData(true);
    it.ratioKey = carouselRatioKey;
    
    // Generar thumb
    const pr = valueFromKey(it.ratioKey);
    const thW = 540;
    const thH = Math.max(1, Math.round(thW / pr));
    
    const c = cropper.getCroppedCanvas({
      width: thW, height: thH,
      imageSmoothingEnabled: true, imageSmoothingQuality: 'high'
    });
    
    if(c){
        it.thumbDataUrl = c.toDataURL('image/jpeg', 0.9);
        renderList(); 
        renderStrip();
        toast('ok', 'Guardado', `Recorte aplicado.`);
    }
  }

  function dataURLToBlob(dataURL){
    const [h,b] = dataURL.split(',');
    const mime = h.match(/:(.*?);/)[1];
    const bin = atob(b);
    const arr = new Uint8Array(bin.length);
    for(let i=0;i<bin.length;i++) arr[i]=bin.charCodeAt(i);
    return new Blob([arr], {type:mime});
  }

  function downloadBlob(blob, filename){
    const a = document.createElement('a');
    const url = URL.createObjectURL(blob);
    a.href=url; a.download=filename;
    document.body.appendChild(a); a.click(); a.remove();
    setTimeout(()=>URL.revokeObjectURL(url), 1500);
  }

  function baseName(name){
    return (name||'image').replace(/\.[a-z0-9]+$/i,'').replace(/[^\w\-]+/g,'_').slice(0,80);
  }

  async function imageFromUrl(url){
    return new Promise((resolve, reject)=>{
      const im = new Image();
      im.onload = ()=> resolve(im);
      im.onerror = reject;
      im.src = url;
    });
  }

  async function exportRecorteToDataURL(it){
    const format = fmt.value;
    const base = parseInt(sizeEl.value,10);
    const quality = parseFloat(q.value);
    const ratioKey = carouselRatioKey || it.ratioKey || keyFromValue(currentRatio);
    const {w:W,h:H} = outDims(ratioKey, base);

    // Si es la imagen activa, usamos el cropper
    if(it === items[selected] && cropper){
      // Aseguramos ratio antes de exportar
      if(carouselRatioKey) cropper.setAspectRatio(valueFromKey(carouselRatioKey));
      const c = cropper.getCroppedCanvas({
        width: W, height: H,
        imageSmoothingEnabled: true,
        imageSmoothingQuality: 'high'
      });
      return c.toDataURL(format==='png'?'image/png':'image/jpeg', quality);
    }

    // Si no es la activa, reconstruimos desde los datos guardados
    const imgEl = await imageFromUrl(it.url);
    const canvas = document.createElement('canvas');
    canvas.width=W; canvas.height=H;
    const ctx = canvas.getContext('2d', {alpha: format==='png'});

    if(format==='jpeg'){
      ctx.fillStyle='#fff';
      ctx.fillRect(0,0,W,H);
    }

    const targetRatio = valueFromKey(ratioKey);
    let sx=0, sy=0, sw=imgEl.naturalWidth, sh=imgEl.naturalHeight;

    if(it.cropData){
      sx=it.cropData.x; sy=it.cropData.y; sw=it.cropData.width; sh=it.cropData.height;
    } else {
      // Auto-center fallback
      const iw=imgEl.naturalWidth, ih=imgEl.naturalHeight, ir=iw/ih;
      if(ir>targetRatio){ sh=ih; sw=Math.round(ih*targetRatio); sx=Math.round((iw-sw)/2); sy=0; }
      else { sw=iw; sh=Math.round(iw/targetRatio); sx=0; sy=Math.round((ih-sh)/2); }
    }

    ctx.imageSmoothingEnabled=true;
    ctx.imageSmoothingQuality='high';
    ctx.drawImage(imgEl, sx, sy, sw, sh, 0, 0, W, H);

    return canvas.toDataURL(format==='png'?'image/png':'image/jpeg', quality);
  }

  async function downloadSelectedRecorte(){
    if(selected<0) return;
    if(cropper) await saveCurrentCrop();
    const it = items[selected];
    const dataUrl = await exportRecorteToDataURL(it);
    const blob = dataURLToBlob(dataUrl);
    const ext = fmt.value==='png'?'png':'jpg';
    const base = parseInt(sizeEl.value,10);
    const rk = (carouselRatioKey || it.ratioKey || keyFromValue(currentRatio)).replace(':','x').replace('.','_');
    const prefix = pad2(selected+1);
    downloadBlob(blob, `${prefix}__${baseName(it.name)}__IG_${rk}__${base}.${ext}`);
    toast('ok', 'Descargada', `${prefix}`);
  }

  async function downloadZIP(){
    if(items.length===0 || busyZip) return;
    if(selected>=0 && cropper) await saveCurrentCrop();
    busyZip = true;
    setDisabled();
    toast('', 'Procesando ZIP', '...');
    const zip = new JSZip();
    const ext = fmt.value==='png'?'png':'jpg';
    const base = parseInt(sizeEl.value,10);
    const rkGlobal = carouselRatioKey || keyFromValue(currentRatio);

    // Im√°genes
    for(let i=0;i<items.length;i++){
      const it = items[i];
      const dataUrl = await exportRecorteToDataURL(it);
      const blob = dataURLToBlob(dataUrl);
      const rk = (rkGlobal).replace(':','x').replace('.','_');
      zip.file(`${pad2(i+1)}__${baseName(it.name)}__IG_${rk}__${base}.${ext}`, blob);
    }
    
    // Caption TXT
    const txtContent = captionText.value.trim();
    if(txtContent) {
        zip.file("caption.txt", txtContent);
    }

    const out = await zip.generateAsync({type:'blob'});
    downloadBlob(out, `caruselforge_${base}px_${(rkGlobal).replace(':','x').replace('.','_')}.zip`);
    busyZip = false;
    setDisabled();
    toast('ok', 'ZIP Listo', `Descarga finalizada.`);
  }

  // Event Listeners
  captionText.addEventListener('input', () => {
      const len = captionText.value.length;
      charCount.textContent = `${len} / 2200`;
      if(len > 2200) charCount.style.color = 'var(--danger)';
      else charCount.style.color = 'var(--text-dim)';
  });

  files.addEventListener('change', (e)=> addFiles(e.target.files));
  
  clearAll.addEventListener('click', ()=>{
    if(items.length && !confirm('¬øVaciar todo el carrusel?')) return;
    destroyCropper();
    items.forEach(it => it.url && URL.revokeObjectURL(it.url));
    items=[]; selected=-1;
    list.innerHTML=''; strip.innerHTML='';
    preview.src=''; dots.innerHTML='';
    img.removeAttribute('src');
    ratioLabel.textContent = '1:1';
    captionText.value = '';
    charCount.textContent = '0 / 2200';
    carouselRatioKey = null;
    currentRatio = 1;
    qVal.textContent = Number(q.value).toFixed(2);
    updateHeader();
    setDisabled();
    toggleEmpty();
    updateRatioModeUI();
    toast('warn', 'Reinicio', 'Carrusel vaciado.');
  });

  [prevBtn,pPrev].forEach(b=> b.addEventListener('click', ()=> moveSelection(-1)));
  [nextBtn,pNext].forEach(b=> b.addEventListener('click', ()=> moveSelection(+1)));

  window.addEventListener('keydown', (e)=>{
    if(e.target === captionText) return; // No atajos si escribes
    if(e.key==='ArrowLeft') moveSelection(-1);
    if(e.key==='ArrowRight') moveSelection(+1);
    // Escape cierra modales
    if(e.key==='Escape') {
        if(modalOverlay.style.display==='flex') closeModal();
        if(helpOverlay.style.display==='flex') helpOverlay.style.display='none';
        if(aiConfigModalOverlay.style.display==='flex') aiConfigModalOverlay.style.display='none';
        if(aiEditModalOverlay.style.display==='flex') aiEditModalOverlay.style.display='none';
    }
  });

  moveUp.addEventListener('click', ()=> moveItem(-1));
  moveDown.addEventListener('click', ()=> moveItem(+1));

  document.querySelectorAll('[data-r]').forEach(b=>{
    b.addEventListener('click', ()=> {
      if(carouselRatioKey){
        toast('warn','Bloqueado', `Usa "Configurar Todo" para cambiar.`);
        return;
      }
      let r = 1;
      try { r = Function(`"use strict"; return (${b.getAttribute('data-r')});`)(); } catch {}
      currentRatio = r;
      ratioLabel.textContent = keyFromValue(r);
      if(cropper) {
          cropper.setAspectRatio(currentRatio);
          setTimeout(syncPreviewRealTime, 50);
      }
      toast('', 'Ratio Libre', `${keyFromValue(r)}`);
    });
  });

  zoomIn.addEventListener('click', ()=> { cropper?.zoom(0.08); setTimeout(syncPreviewRealTime,50); });
  zoomOut.addEventListener('click', ()=> { cropper?.zoom(-0.08); setTimeout(syncPreviewRealTime,50); });
  rotL.addEventListener('click', ()=> { cropper?.rotate(-90); setTimeout(syncPreviewRealTime,50); });
  rotR.addEventListener('click', ()=> { cropper?.rotate(90); setTimeout(syncPreviewRealTime,50); });
  reset.addEventListener('click', ()=> { cropper?.reset(); setTimeout(syncPreviewRealTime,50); });
  
  saveCrop.addEventListener('click', saveCurrentCrop);
  q.addEventListener('input', ()=> qVal.textContent = Number(q.value).toFixed(2));
  dlOne.addEventListener('click', downloadSelectedRecorte);
  exportCropBtn.addEventListener('click', downloadSelectedRecorte);
  dlZip.addEventListener('click', downloadZIP);

  const stop = (e)=>{ e.preventDefault(); e.stopPropagation(); };
  ['dragenter','dragover'].forEach(ev=>{
    dropzone.addEventListener(ev, (e)=>{ stop(e); dropzone.classList.add('drag'); });
  });
  ['dragleave','drop'].forEach(ev=>{
    dropzone.addEventListener(ev, (e)=>{ stop(e); dropzone.classList.remove('drag'); });
  });
  dropzone.addEventListener('drop', (e)=>{
    const dt = e.dataTransfer;
    if(dt?.files?.length) addFiles(dt.files);
  });

  // Modal Ratio Events
  changeRatioBtn.addEventListener('click', () => {
    if(items.length===0) return;
    openModal();
  });
  modalClose.addEventListener('click', closeModal);
  modalCancel.addEventListener('click', closeModal);
  modalOverlay.addEventListener('click', (e)=> {
    if(e.target === modalOverlay) closeModal();
  });
  modalApply.addEventListener('click', () => {
    const newKey = modalRatio.value;
    if(items.length && !confirm(`¬øAplicar ${newKey} a todo? Se perder√°n ajustes manuales.`)) return;
    applyCarouselRatio(newKey);
    closeModal();
  });

  // Modal Help Events
  const closeHelp = () => helpOverlay.style.display='none';
  helpBtn.addEventListener('click', () => helpOverlay.style.display='flex');
  helpCloseBtn.addEventListener('click', closeHelp);
  helpOkBtn.addEventListener('click', closeHelp);
  helpOverlay.addEventListener('click', (e) => {
      if(e.target===helpOverlay) closeHelp();
  });


  qVal.textContent = Number(q.value).toFixed(2);
  updateAiUi();
  setDisabled();
  updateHeader();
  toggleEmpty();
  updateRatioModeUI();
})();
</script>
</body>
</html>
