<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>CaruselForge | Editor & AI</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.2/cropper.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.2/cropper.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

  <link rel="stylesheet" href="styles.css"> 
</head>

<body>
<header>
  <div class="brand">
    <div class="logo">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <rect x="2" y="7" width="20" height="10" rx="2" ry="2"></rect>
        <path d="M12 7v10"></path>
      </svg>
    </div>
    <div class="titleWrap">
      <p class="title">CaruselForge</p>
    </div>
  </div>

  <div id="headerMsg"></div>

  <div class="topActions">
    <button class="btn" id="helpBtn" title="Instrucciones">Ayuda</button>
    <button class="btn" id="replicateSettings" title="Configurar API Key Replicate">üñºÔ∏è AI</button>
    <button class="btn" id="aiSettings" title="Configurar API Key">‚öôÔ∏è AI</button>
    <button class="btn bad" id="clearAll" title="Vaciar todo">Vaciar</button>
  </div>
</header>

<main>
  <section class="card">
    <div class="cardTop">
      <div class="cardTitle">
        <h2>Im√°genes</h2>
      </div>
      <div style="display:flex; gap:6px">
         <button class="btn" id="moveUp" title="Subir" style="padding:0 8px">‚Üë</button>
         <button class="btn" id="moveDown" title="Bajar" style="padding:0 8px">‚Üì</button>
      </div>
    </div>

    <div class="cardBody">
      <label class="dropzone" id="dropzone" style="cursor:pointer">
        <input id="files" type="file" accept="image/*" multiple>
        <div class="dropLeft">
          <div class="spark">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
               <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
               <polyline points="17 8 12 3 7 8"></polyline>
               <line x1="12" y1="3" x2="12" y2="15"></line>
            </svg>
          </div>
          <div class="dropText">
            <div class="a">A√±adir fotos</div>
          </div>
        </div>
      </label>

      <div id="empty" class="empty" style="display:none">
        Arrastra tus im√°genes aqu√≠
      </div>

      <div class="kpi">
        <span>Fotos:</span> <strong id="count">0</strong>
        <span style="opacity:.3; margin:0 6px">|</span>
        <span style="white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:80px" id="selName">‚Äî</span>
      </div>

      <div class="list" id="list"></div>

      <div style="margin-top:10px; display:flex; gap:6px; flex: 0 0 auto;">
        <button class="btn" id="prev">Ant</button>
        <button class="btn" id="next">Sig</button>
      </div>
    </div>
  </section>
  
  <section class="card centerCol" style="border:none; background:transparent; box-shadow:none; overflow:hidden">
    <div class="editorToolbar">
        <div style="display:flex; align-items:center; gap:12px">
            <div class="kpi" style="margin:0; background:transparent; padding:0">
                <span class="label">Ratio Actual</span>
                <strong id="ratioLabel" style="font-size:13px">1:1</strong>
                <small id="ratioMode" style="color:var(--text-dim); margin-left:4px">(Libre)</small>
            </div>
        </div>
        <button class="btn" id="changeRatio" style="height:26px; font-size:11px">Configurar Todo</button>
    </div>

    <div class="editorWrap">
      <div class="editorTop">
        <div class="toolGroup">
          <span class="label">Ratios</span>
          <button class="btn" data-r="1" style="padding:0 8px">1:1</button>
          <button class="btn" data-r="4/5" style="padding:0 8px">4:5</button>
          <button class="btn" data-r="9/16" style="padding:0 8px">9:16</button>
          <button class="btn" data-r="3/2" style="padding:0 8px">3:2</button>
          <button class="btn" data-r="4/3" style="padding:0 8px">4:3</button>
        </div>

        <div class="toolGroup" style="margin-left:auto; margin-right:8px">
            <button class="btn" id="rotL" title="Rotar izq" style="padding:0 8px">‚ü≤</button>
            <button class="btn" id="rotR" title="Rotar der" style="padding:0 8px">‚ü≥</button>
            <button class="btn" id="zoomOut" title="Zoom -" style="padding:0 8px">‚àí</button>
            <button class="btn" id="zoomIn" title="Zoom +" style="padding:0 8px">+</button>
        </div>
        
        <div class="toolGroup">
            <button class="btn" id="reset">Reset</button>
            <button class="btn primary" id="saveCrop">Guardar</button>
        </div>
      </div>

      <div class="editorCanvas" id="editorCanvas">
        <img id="image" alt="">
      </div>
    </div>
  </section>

  <section class="card">
    <div class="cardTop">
      <div class="cardTitle">
        <h2>Vista Previa</h2>
      </div>
    </div>

    <div class="cardBody previewBody">
      <div class="feed">
        <div class="feedHead">
          <div class="avatar"></div>
          <div>
            <div style="height:8px; width:80px; background:#333; border-radius:4px; margin-bottom:4px"></div>
            <div style="height:6px; width:50px; background:#222; border-radius:4px"></div>
          </div>
        </div>

        <div class="media" id="media">
          <img id="preview" alt="">
          <div class="nav">
            <button id="pPrev">‚Äπ</button>
            <button id="pNext">‚Ä∫</button>
          </div>
          <div class="dots" id="dots"></div>
        </div>

        <div class="feedFoot">
             <div style="display:flex; gap:10px">
                 <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#ccc" stroke-width="2"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg>
                 <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#ccc" stroke-width="2"><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"></path></svg>
             </div>
        </div>
      </div>

      <div class="captionArea">
          <div style="display:flex; justify-content:space-between; margin-bottom:4px; align-items:flex-end">
            <label class="label">Texto para el post</label>
            <div style="display:flex; gap:8px; align-items:center">
                <button id="aiFixBtn" class="btn primary" style="height:20px; font-size:10px; padding:0 6px; display:none;">‚ú® Mejorar IA</button>
                <span id="charCount" style="font-size:10px; color:var(--text-dim)">0 / 2200</span>
            </div>
          </div>
          <textarea id="captionText" class="captionInput" placeholder="Escribe aqu√≠ tu copy..."></textarea>
      </div>

      <div class="exportSection">
          <h3 style="font-size:11px; text-transform:uppercase; color:var(--text-dim); margin:0 0 8px 0;">Exportar</h3>
          
          <div style="display:grid; grid-template-columns: 1fr 1fr; gap:8px; margin-bottom:8px">
              <div>
                  <label class="label">Tama√±o</label>
                  <select class="select" id="size" style="width:100%">
                    <option value="1080" selected>1080px</option>
                    <option value="2160">2160px (Hi-Res)</option>
                  </select>
              </div>
              <div>
                  <label class="label">Formato</label>
                  <select class="select" id="fmt" style="width:100%">
                    <option value="jpeg" selected>JPG</option>
                    <option value="png">PNG</option>
                  </select>
              </div>
          </div>
          
          <div style="margin-bottom:12px">
             <div style="display:flex; justify-content:space-between;">
                 <label class="label">Calidad</label>
                 <strong id="qVal" style="font-size:10px">0.95</strong>
             </div>
             <input id="q" type="range" min="0.80" max="1.00" step="0.01" value="0.95" style="width:100%">
          </div>

          <div style="display:flex; flex-direction:column; gap:6px">
              <button class="btn primary" id="dlZip" style="height:38px; width:100%">
                Descargar Todo (ZIP)
              </button>
              
              <div style="display:flex; gap:6px">
                 <button class="btn" id="dlOne" style="flex:1">Esta foto</button>
                 <button class="btn" id="exportCrop" title="Recorte exacto" style="width:36px; padding:0">‚úÇ</button>
              </div>
          </div>
      </div>
    </div>
  </section>
  
  <section class="card" style="grid-column:1; margin-top: -16px;">
    <div class="cardTop">
        <div class="cardTitle">
            <h2>üñºÔ∏è Generar Imagen (Replicate)</h2>
        </div>
    </div>
    <div class="cardBody">
        <label class="label">Prompt:</label>
        <textarea id="replicatePrompt" class="captionInput" placeholder="Describe la imagen a generar... (ej: un perro astronauta, estilo √≥leo)"></textarea>

        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:8px; margin-top:12px">
            <div>
                <label class="label">Ratio</label>
                <select class="select" id="replicateRatio" style="width:100%">
                    <option value="1:1" selected>1:1 (Cuadrado)</option>
                    <option value="4:5">4:5 (Retrato)</option>
                    <option value="9:16">9:16 (Story)</option>
                </select>
            </div>
            <div>
                <label class="label">A√±adir Seleccionada?</label>
                <select class="select" id="replicateInputImage" style="width:100%">
                    <option value="no" selected>No (Generaci√≥n Pura)</option>
                    <option value="yes">S√≠ (Image-to-Image)</option>
                </select>
            </div>
        </div>

        <button class="btn primary" id="generateImageBtn" style="margin-top:12px; height:38px; width:100%">
            ‚ú® Generar Imagen
        </button>
    </div>
  </section>
  </main>

<div class="stripWrap">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:6px">
        <h3 style="font-size:11px; margin:0; color:var(--text-muted)">STORYBOARD</h3>
    </div>
    <div class="card" style="border-radius: var(--radius-lg); background:var(--surface-2)">
        <div class="strip" id="strip"></div>
    </div>
</div>

<div class="modalOverlay" id="modalOverlay">
  <div class="modal">
    <div class="modalTop">
      <b id="modalTitle">Ratio Global</b>
      <button class="btn" id="modalClose" style="border:none; background:transparent; padding:0; width:24px;">‚úï</button>
    </div>
    <div class="modalBody">
      <p style="color:var(--text-muted); margin-bottom:12px; font-size:13px">
        Aplica un formato √∫nico a todas las im√°genes.
      </p>
      <div style="display:flex; flex-direction:column; gap:6px">
        <select class="select" id="modalRatio" style="width:100%">
          <option value="1:1">1:1 (Cuadrado)</option>
          <option value="4:5">4:5 (Retrato)</option>
          <option value="9:16">9:16 (Story)</option>
          <option value="3:2">3:2 (Horizontal)</option>
          <option value="4:3">4:3 (Est√°ndar)</option>
          <option value="1.91:1">1.91:1 (Banner)</option>
        </select>
      </div>
    </div>
    <div class="modalActions">
      <button class="btn" id="modalCancel">Cancelar</button>
      <button class="btn primary" id="modalApply">Aplicar</button>
    </div>
  </div>
</div>

<div class="modalOverlay" id="helpOverlay" style="z-index:210">
  <div class="modal" style="width:600px; max-width:95%">
    <div class="modalTop">
      <b>üìö Instrucciones & API Guide</b>
      <button class="btn" id="helpCloseBtn" style="border:none; background:transparent; padding:0; width:24px;">‚úï</button>
    </div>
    <div class="modalBody">
      <div class="helpBlock">
        <h4>1. Flujo de Trabajo</h4>
        <ul>
            <li><b>Sube im√°genes:</b> Arrastra archivos o usa el bot√≥n "A√±adir".</li>
            <li><b>Edita:</b> Ajusta el recorte. Puedes usar un ratio libre o forzar el 4:5 (Instagram).</li>
            <li><b>Ordena:</b> Arrastra las fotos en el "Storyboard" inferior para cambiar el orden.</li>
            <li><b>Exporta:</b> Descarga un ZIP con todas las im√°genes listas para publicar.</li>
        </ul>
      </div>

      <div class="helpBlock">
        <h4>2. ¬øQu√© es la Inteligencia Artificial (IA)?</h4>
        <p>Esta herramienta se conecta con <b>OpenAI (GPT)</b> para corregir la ortograf√≠a y mejorar el "gancho" de tus textos autom√°ticamente.</p>
        <p>Y con <b>Replicate</b> para generar nuevas im√°genes.</p>
        <p>Para usarlo, necesitas una <b>API Key</b> (una contrase√±a especial).</p>
      </div>

      <div class="helpBlock">
        <h4>3. ¬øC√≥mo obtener tu API Key?</h4>
        <ol>
            <li>Ve a <a href="https://platform.openai.com/api-keys" target="_blank" style="color:var(--primary)">platform.openai.com</a>. (Para el texto)</li>
            <li>Ve a <a href="https://replicate.com/account/api-tokens" target="_blank" style="color:var(--primary)">replicate.com/account/api-tokens</a>. (Para las im√°genes)</li>
            <li>Copia la clave que empieza por <code>sk-...</code> o <code>r8-...</code> respectivamente.</li>
        </ol>
      </div>

      <div class="helpBlock">
        <h4>4. Configuraci√≥n Segura</h4>
        <p>Pulsa el bot√≥n <b>‚öôÔ∏è AI</b> o <b>üñºÔ∏è AI</b> en el men√∫ superior y pega tu clave.</p>
        <div class="codeBox">Tu clave se guarda en TU navegador (LocalStorage). Nosotros no tenemos servidores ni acceso a ella.</div>
      </div>
    </div>
    <div class="modalActions">
      <button class="btn primary" id="helpOkBtn">Entendido</button>
    </div>
  </div>
</div>

<script src="utils.js"></script>
<script src="app.js"></script>
</body>
</html>